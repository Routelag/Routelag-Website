<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RouteLag - Dashboard</title>
    <link rel="icon" href="Logo.png" type="image/png">
    <link rel="stylesheet" href="assets/css/home2-style.css">
    <link rel="stylesheet" href="assets/css/auth.css">
    <link rel="stylesheet" href="assets/css/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- Chart.js for performance metrics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <style>
    /* Critical inline styles */
    body {
        background-color: #0a0a0a;
        color: white;
        font-family: 'Montserrat', sans-serif;
    }
    .navbar {
        position: relative !important;
    }
    .dashboard-container {
        width: 100%;
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
        display: block !important;
    }
    .dashboard-layout {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }
    @media (max-width: 992px) {
        .dashboard-layout {
            grid-template-columns: 1fr;
        }
    }
    .main-card {
        background-color: #141824;
        border-radius: 10px;
        padding: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 20px;
    }
    </style>
    <!-- Navigation -->
    <nav class="navbar">
        <a href="index.html" class="logo-container">
            <img src="Logo.png" alt="RouteLag Logo" class="logo">
        </a>
    
        <button class="hamburger-menu">
            <i class="fas fa-bars"></i>
        </button>
    
        <div class="nav-center">
            <a href="index.html" class="nav-link">HOME</a>
            <a href="index.html#games" class="nav-link">GAMES</a>
            <a href="index.html#pricing" class="nav-link">PRICING</a>
            <a href="comingsoon.html" class="nav-link">DOWNLOAD</a>
            <a href="about.html" class="nav-link">ABOUT</a>
            <a href="index.html#faq" class="nav-link">FAQ</a>
            <a href="support.html" class="nav-link">SUPPORT</a>
            <a href="https://discord.gg/X8VBmhYnKa" class="nav-link" target="_blank"><i class="fab fa-discord"></i> DISCORD</a>
        </div>
    
        <div class="auth-buttons">
            <div id="offline-indicator" style="display: none; margin-right: 10px; background-color: #ff3b30; color: white; font-size: 0.8rem; padding: 3px 8px; border-radius: 12px;">
                <i class="fas fa-wifi-slash"></i> Offline
            </div>
            <div style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <span class="user-name" style="color: white; font-weight: 600;"></span>
                <button class="signout-button" style="background: none; border: none; color: #ff5959; font-size: 0.9rem; cursor: pointer;">
                    <i class="fas fa-sign-out-alt"></i> Sign Out
                </button>
            </div>
        </div>

       
    </nav>

    <!-- Dashboard Container -->
    <div class="dashboard-container">
        <!-- Error message container that can be shown/hidden via JS -->
        <div id="errorContainer" style="display: none; background-color: rgba(255, 59, 48, 0.1); border-left: 4px solid #ff3b30; color: #ff3b30; padding: 12px; margin-bottom: 20px; border-radius: 4px;">
            <i class="fas fa-exclamation-circle"></i> <span id="errorMessage">There was an error loading some dashboard components</span>
            <button id="retryConnection" style="background: #ff3b30; border: none; color: white; padding: 4px 8px; border-radius: 4px; margin-left: 10px; cursor: pointer; display: none;">
                <i class="fas fa-sync-alt"></i> Retry
            </button>
            <button id="dismissError" style="background: none; border: none; color: #ff3b30; float: right; cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="dashboard-header">
            <h1 class="dashboard-title">Welcome, <span class="user-name">User</span>!</h1>
            <div class="dashboard-actions">
                <a href="comingsoon.html" class="action-button primary">
                    <i class="fas fa-download"></i> Download RouteLag
                </a>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="dashboard-grid">
            <div class="stats-card">
                <div class="stats-card-header">
                    <h3 class="stats-card-title">Subscription Plan</h3>
                    <div class="stats-card-icon">
                        <i class="fas fa-crown"></i>
                    </div>
                </div>
                <div class="stats-card-value user-plan">Free</div>
                <div class="stats-card-label">Current Active Plan</div>
            </div>

            <div class="stats-card">
                <div class="stats-card-header">
                    <h3 class="stats-card-title">Ping Reduction</h3>
                    <div class="stats-card-icon">
                        <i class="fas fa-bolt"></i>
                    </div>
                </div>
                <div class="stats-card-value">
                    <span class="ping-reduction">0%</span>
                </div>
                <div class="stats-card-label">Average Improvement</div>
            </div>

            <div class="stats-card">
                <div class="stats-card-header">
                    <h3 class="stats-card-title">FPS Boost</h3>
                    <div class="stats-card-icon">
                        <i class="fas fa-tachometer-alt"></i>
                    </div>
                </div>
                <div class="stats-card-value">
                    <span class="fps-boost">0%</span>
                </div>
                <div class="stats-card-label">Performance Increase</div>
            </div>
        </div>

        <!-- Dashboard Layout -->
        <div class="dashboard-layout">
            <!-- Main Content Area -->
            <div class="dashboard-main">
                <!-- Performance Card -->
                <div class="main-card">
                    <div class="card-header">
                        <h2 class="card-title">Performance Overview</h2>
                        <div class="card-actions">
                            <button class="action-button" id="refreshButton">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="performanceChart"></canvas>
                    </div>
                    
                    <div class="performance-metrics">
                        <div class="metric-item">
                            <div class="metric-value" id="avgFps">0</div>
                            <div class="metric-label">Average FPS</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value" id="avgPing">0ms</div>
                            <div class="metric-label">Average Ping</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value" id="totalOptimizations">0</div>
                            <div class="metric-label">Optimizations</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value" id="lastOptimized">Never</div>
                            <div class="metric-label">Last Optimized</div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions Card -->
                <div class="main-card">
                    <div class="card-header">
                        <h2 class="card-title">Quick Actions</h2>
                    </div>
                    
                    <div class="quick-actions">
                        <a href="comingsoon.html" class="quick-action-btn">
                            <i class="fas fa-magic"></i>
                            <span>Optimize PC</span>
                        </a>
                        <a href="comingsoon.html" class="quick-action-btn">
                            <i class="fas fa-gamepad"></i>
                            <span>Game Optimizer</span>
                        </a>
                        <a href="comingsoon.html" class="quick-action-btn">
                            <i class="fas fa-network-wired"></i>
                            <span>Network Booster</span>
                        </a>
                        <a href="comingsoon.html" class="quick-action-btn">
                            <i class="fas fa-broom"></i>
                            <span>System Cleanup</span>
                        </a>
                    </div>
                </div>
                
                <!-- Games Optimization Card -->
                <div class="main-card">
                    <div class="card-header">
                        <h2 class="card-title">Your Games</h2>
                        <div class="card-actions">
                            <button class="action-button">
                                <i class="fas fa-plus"></i> Add Game
                            </button>
                        </div>
                    </div>
                    
                    <div class="tabs-container">
                        <div class="tabs-header">
                            <div class="tab-btn active" data-tab="all-games">All Games</div>
                            <div class="tab-btn" data-tab="optimized-games">Optimized</div>
                            <div class="tab-btn" data-tab="needs-optimization">Needs Optimization</div>
                        </div>
                        
                        <div class="tab-content active" id="all-games">
                            <div id="gamesList">
                                <!-- Games will be populated from JS -->
                                <div class="empty-state">
                                    <i class="fas fa-gamepad" style="font-size: 2rem; margin-bottom: 1rem; color: var(--primary);"></i>
                                    <p>No games added yet</p>
                                    <p style="margin-top: 0.5rem;">Add your favorite games to optimize them</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-content" id="optimized-games">
                            <div class="empty-state">
                                <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 1rem; color: var(--success-color);"></i>
                                <p>No optimized games yet</p>
                                <p style="margin-top: 0.5rem;">Optimize your games for better performance</p>
                            </div>
                        </div>
                        
                        <div class="tab-content" id="needs-optimization">
                            <div class="empty-state">
                                <i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 1rem; color: var(--error-color);"></i>
                                <p>No games need optimization</p>
                                <p style="margin-top: 0.5rem;">Add games to see optimization opportunities</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="dashboard-sidebar">
                <!-- Account Info -->
                <div class="main-card">
                    <div class="card-header">
                        <h2 class="card-title">Account Information</h2>
                    </div>
                    <div>
                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="font-size: 1rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Username</h3>
                            <p class="user-name" style="font-size: 1.2rem; color: var(--text-light);">User</p>
                        </div>
                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="font-size: 1rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Email</h3>
                            <p class="user-email" style="font-size: 1.2rem; color: var(--text-light);">user@example.com</p>
                        </div>
                        <div>
                            <h3 style="font-size: 1rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Subscription</h3>
                            <p class="user-plan" style="font-size: 1.2rem; color: var(--text-light);">Free</p>
                        </div>
                    </div>
                </div>
                
                <!-- Account Settings Card -->
                <div class="main-card">
                    <div class="card-header">
                        <h2 class="card-title">Account Settings</h2>
                    </div>
                    
                    <div class="tabs-container">
                        <div class="tabs-header">
                            <div class="tab-btn active" data-tab="change-username">Username</div>
                            <div class="tab-btn" data-tab="change-password">Password</div>
                            <div class="tab-btn" data-tab="delete-account">Delete Account</div>
                        </div>
                        
                        <div class="tab-content active" id="change-username">
                            <div style="padding: 1rem 0;">
                                <div id="usernameUpdateSuccess" class="form-success" style="display: none; margin-bottom: 1rem;">
                                    Username updated successfully!
                                </div>
                                <div id="usernameUpdateError" class="form-error" style="display: none; margin-bottom: 1rem;"></div>
                                
                                <div class="form-group">
                                    <label for="newUsername" class="form-label">New Username</label>
                                    <input type="text" id="newUsername" class="form-control" placeholder="Enter new username" required>
                                </div>
                                
                                <button id="updateUsernameBtn" class="auth-button" style="width: 100%;">
                                    UPDATE USERNAME
                                </button>
                            </div>
                        </div>
                        
                        <div class="tab-content" id="change-password">
                            <div style="padding: 1rem 0;">
                                <div id="passwordUpdateSuccess" class="form-success" style="display: none; margin-bottom: 1rem;">
                                    Password updated successfully!
                                </div>
                                <div id="passwordUpdateError" class="form-error" style="display: none; margin-bottom: 1rem;"></div>
                                
                                <div class="form-group">
                                    <label for="currentPassword" class="form-label">Current Password</label>
                                    <input type="password" id="currentPassword" class="form-control" placeholder="Enter current password" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="newPassword" class="form-label">New Password</label>
                                    <input type="password" id="newPassword" class="form-control" placeholder="Enter new password" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="confirmNewPassword" class="form-label">Confirm New Password</label>
                                    <input type="password" id="confirmNewPassword" class="form-control" placeholder="Confirm new password" required>
                                </div>
                                
                                <button id="updatePasswordBtn" class="auth-button" style="width: 100%;">
                                    UPDATE PASSWORD
                                </button>
                            </div>
                        </div>
                        
                        <div class="tab-content" id="delete-account">
                            <div style="padding: 1rem 0;">
                                <div class="form-group" style="margin-bottom: 1.5rem;">
                                    <div class="alert-warning" style="background-color: rgba(255, 89, 89, 0.1); border-left: 3px solid var(--error-color); padding: 1rem; border-radius: 4px;">
                                        <h4 style="color: var(--error-color); margin-bottom: 0.5rem;">Warning: This action cannot be undone</h4>
                                        <p style="color: var(--text-secondary);">Deleting your account will permanently remove all your data, including your profile, statistics, and optimizations. You will not be able to recover this information later.</p>
                                    </div>
                                </div>
                                
                                <div id="deleteAccountError" class="form-error" style="display: none; margin-bottom: 1rem;"></div>
                                
                                <div class="form-group">
                                    <label for="deleteAccountPassword" class="form-label">Current Password</label>
                                    <input type="password" id="deleteAccountPassword" class="form-control" placeholder="Enter your password to confirm" required>
                                </div>
                                
                                <div class="form-group" style="margin-top: 1rem;">
                                    <div class="checkbox">
                                        <input type="checkbox" id="confirmAccountDeletion" required>
                                        <label for="confirmAccountDeletion" style="display: inline; color: var(--text-secondary);">
                                            I understand that this action cannot be undone
                                        </label>
                                    </div>
                                </div>
                                
                                <button id="deleteAccountBtn" class="auth-button" style="width: 100%; background-color: var(--error-color); margin-top: 1rem;">
                                    DELETE MY ACCOUNT
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Devices Card -->
                <div class="main-card">
                    <div class="card-header">
                        <h2 class="card-title">Your Devices</h2>
                        <div class="card-actions">
                            <button class="action-button">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                    </div>
                    
                    <div id="devicesList">
                        <!-- Devices will be populated from JS -->
                        <div class="empty-state">
                            <i class="fas fa-desktop" style="font-size: 2rem; margin-bottom: 1rem; color: var(--primary);"></i>
                            <p>No devices added yet</p>
                        </div>
                    </div>
                </div>
                
                <!-- Activity Log Card -->
                <div class="main-card">
                    <div class="card-header">
                        <h2 class="card-title">Recent Activity</h2>
                    </div>
                    
                    <div id="activityList" class="activity-list">
                        <!-- Activities will be populated from JS -->
                        <div class="empty-state">
                            <i class="fas fa-history" style="font-size: 2rem; margin-bottom: 1rem; color: var(--primary);"></i>
                            <p>No recent activity</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Subscription Features Card -->
        <div class="main-card">
            <div class="card-header">
                <h2 class="card-title">Your RouteLag Features</h2>
                <div class="card-actions">
                    <a href="index.html#pricing" class="action-button primary">Upgrade Plan</a>
                </div>
            </div>
            
            <!-- Free Plan Features -->
            <div class="free-content">
                <div style="margin-top: 1rem; margin-bottom: 2rem;">
                    <h3 style="font-size: 1.2rem; color: var(--text-light); margin-bottom: 1rem;">Free Plan Features</h3>
                    <ul style="list-style-type: none; padding: 0;">
                        <li style="margin-bottom: 0.8rem; display: flex; align-items: center;">
                            <i class="fas fa-check" style="color: var(--success-color); margin-right: 0.8rem;"></i>
                            <span>40 Optimizations</span>
                        </li>
                        <li style="margin-bottom: 0.8rem; display: flex; align-items: center;">
                            <i class="fas fa-check" style="color: var(--success-color); margin-right: 0.8rem;"></i>
                            <span>Estimated 20% FPS Boost</span>
                        </li>
                        <li style="margin-bottom: 0.8rem; display: flex; align-items: center;">
                            <i class="fas fa-check" style="color: var(--success-color); margin-right: 0.8rem;"></i>
                            <span>Debloat & PC Cleanup Feature</span>
                        </li>
                        <li style="margin-bottom: 0.8rem; display: flex; align-items: center;">
                            <i class="fas fa-check" style="color: var(--success-color); margin-right: 0.8rem;"></i>
                            <span>Disable Useless Features</span>
                        </li>
                    </ul>
                    <div style="margin-top: 1.5rem;">
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">Want more optimizations and better performance?</p>
                        <a href="index.html#pricing" class="action-button primary">Upgrade to Basic Plan</a>
                    </div>
                </div>
            </div>
            
            <!-- Basic Plan Features -->
            <div class="basic-content" style="display: none;">
                <div style="margin-top: 1rem; margin-bottom: 2rem;">
                    <h3 style="font-size: 1.2rem; color: var(--text-light); margin-bottom: 1rem;">Basic Plan Features</h3>
                    <ul style="list-style-type: none; padding: 0;">
                        <li style="margin-bottom: 0.8rem; display: flex; align-items: center;">
                            <i class="fas fa-check" style="color: var(--success-color); margin-right: 0.8rem;"></i>
                            <span>200+ Optimizations</span>
                        </li>
                        <li style="margin-bottom: 0.8rem; display: flex; align-items: center;">
                            <i class="fas fa-check" style="color: var(--success-color); margin-right: 0.8rem;"></i>
                            <span>Estimated 40-50% FPS Boost</span>
                        </li>
                        <li style="margin-bottom: 0.8rem; display: flex; align-items: center;">
                            <i class="fas fa-check" style="color: var(--success-color); margin-right: 0.8rem;"></i>
                            <span>Advanced Configurations</span>
                        </li>
                        <li style="margin-bottom: 0.8rem; display: flex; align-items: center;">
                            <i class="fas fa-check" style="color: var(--success-color); margin-right: 0.8rem;"></i>
                            <span>Low Latency & Delay</span>
                        </li>
                        <li style="margin-bottom: 0.8rem; display: flex; align-items: center;">
                            <i class="fas fa-check" style="color: var(--success-color); margin-right: 0.8rem;"></i>
                            <span>Game Settings Configuration</span>
                        </li>
                        <li style="margin-bottom: 0.8rem; display: flex; align-items: center;">
                            <i class="fas fa-check" style="color: var(--success-color); margin-right: 0.8rem;"></i>
                            <span>Priority Support</span>
                        </li>
                    </ul>
                    <div style="margin-top: 1.5rem;">
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">Want even more advanced features?</p>
                        <a href="index.html#pricing" class="action-button primary">Upgrade to Plus Plan</a>
                    </div>
                </div>
            </div>
            
            <!-- Plus Plan Features -->
            <div class="plus-content" style="display: none;">
                <div style="margin-top: 1rem; margin-bottom: 2rem;">
                    <h3 style="font-size: 1.2rem; color: var(--text-light); margin-bottom: 1rem;">Plus Plan Features</h3>
                    <ul style="list-style-type: none; padding: 0;">
                        <li style="margin-bottom: 0.8rem; display: flex; align-items: center;">
                            <i class="fas fa-check" style="color: var(--success-color); margin-right: 0.8rem;"></i>
                            <span>200+ Optimizations</span>
                        </li>
                        <li style="margin-bottom: 0.8rem; display: flex; align-items: center;">
                            <i class="fas fa-check" style="color: var(--success-color); margin-right: 0.8rem;"></i>
                            <span>Estimated 60%+ FPS Boost</span>
                        </li>
                        <li style="margin-bottom: 0.8rem; display: flex; align-items: center;">
                            <i class="fas fa-check" style="color: var(--success-color); margin-right: 0.8rem;"></i>
                            <span>Custom Crosshair Feature</span>
                        </li>
                        <li style="margin-bottom: 0.8rem; display: flex; align-items: center;">
                            <i class="fas fa-check" style="color: var(--success-color); margin-right: 0.8rem;"></i>
                            <span>Unlock Hidden BIOS Settings</span>
                        </li>
                        <li style="margin-bottom: 0.8rem; display: flex; align-items: center;">
                            <i class="fas fa-check" style="color: var(--success-color); margin-right: 0.8rem;"></i>
                            <span>Stabilize & Remove FPS Drops</span>
                        </li>
                        <li style="margin-bottom: 0.8rem; display: flex; align-items: center;">
                            <i class="fas fa-check" style="color: var(--success-color); margin-right: 0.8rem;"></i>
                            <span>Stabilize Ping & Latency</span>
                        </li>
                        <li style="margin-bottom: 0.8rem; display: flex; align-items: center;">
                            <i class="fas fa-check" style="color: var(--success-color); margin-right: 0.8rem;"></i>
                            <span>Advanced Game Configurations</span>
                        </li>
                        <li style="margin-bottom: 0.8rem; display: flex; align-items: center;">
                            <i class="fas fa-check" style="color: var(--success-color); margin-right: 0.8rem;"></i>
                            <span>Priority Support</span>
                        </li>
                    </ul>
                    <div style="margin-top: 1.5rem;">
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">You have the best plan! Download the app to get started.</p>
                        <a href="comingsoon.html" class="action-button primary">Download RouteLag</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-logo">
                <img src="Logo.png" alt="RouteLag Logo" class="logo">
                <span>RouteLag</span>
            </div>
            <div class="footer-links">
                <div class="footer-column">
                    <h4>Product</h4>
                    <ul>
                        <li><a href="index.html#features">Features</a></li>
                        <li><a href="index.html#pricing">Pricing</a></li>
                        <li><a href="comingsoon.html">Download</a></li>
                        <li><a href="index.html#comparison">Compare</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h4>Company</h4>
                    <ul>
                        <li><a href="about.html">About Us</a></li>
                        <li><a href="roadmap.html">Roadmap</a></li>
                        <li><a href="comingsoon.html">Partners</a></li>
                        <li><a href="support.html">Support</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="comingsoon.html">Blog</a></li>
                        <li><a href="https://discord.gg/X8VBmhYnKa">Community</a></li>
                        <li><a href="index.html#faq">FAQ</a></li>
                        <li><a href="comingsoon.html">Tutorials</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h4>Connect</h4>
                    <div class="social-icons">
                        <a href="https://discord.gg/X8VBmhYnKa"><i class="fab fa-discord"></i></a>
                        <a href="https://x.com/RouteLag2025"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="https://www.youtube.com/@RouteLag"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
            </div>
        </div>
         <div class="footer-bottom">
            <p>&copy; 2024 RouteLag. All rights reserved.</p>
            <div class="footer-bottom-links">
                <a href="legal.html">Terms of Service</a>
                <a href="legal.html">Privacy Policy</a>
                <a href="legal.html">Refund Policy</a>
            </div>
        </div>
    </footer>

    <script src="assets/js/home2-script.js"></script>
    <script src="assets/js/auth.js"></script>
    <script>
        // Debug any potential issues
        console.log("Dashboard script loaded");
        
        // Ensure the dashboard loads even if there are errors in the script
        window.addEventListener('load', function() {
            setTimeout(function() {
                // Force display dashboard if it's not already visible
                const dashboardContainer = document.querySelector('.dashboard-container');
                if (dashboardContainer && getComputedStyle(dashboardContainer).display === 'none') {
                    console.log("Force displaying dashboard after load timeout");
                    dashboardContainer.style.display = 'block';
                    
                    // Set default values for key elements
                    const defaultUser = 'User';
                    const defaultEmail = 'user@example.com';
                    const defaultPlan = 'Free';
                    
                    // Set username elements
                    const usernameElements = document.getElementsByClassName('user-name');
                    for (let i = 0; i < usernameElements.length; i++) {
                        if (!usernameElements[i].textContent || usernameElements[i].textContent.trim() === '') {
                            usernameElements[i].textContent = defaultUser;
                        }
                    }
                    
                    // Set email elements
                    const emailElements = document.getElementsByClassName('user-email');
                    for (let i = 0; i < emailElements.length; i++) {
                        if (!emailElements[i].textContent || emailElements[i].textContent.trim() === '') {
                            emailElements[i].textContent = defaultEmail;
                        }
                    }
                    
                    // Set plan elements
                    const planElements = document.getElementsByClassName('user-plan');
                    for (let i = 0; i < planElements.length; i++) {
                        if (!planElements[i].textContent || planElements[i].textContent.trim() === '') {
                            planElements[i].textContent = defaultPlan;
                        }
                    }
                }
            }, 5000); // Last resort - 5 second timeout
        });
        
        // Dashboard specific scripts
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM content loaded");
            
            // Force display dashboard content
            document.querySelector('.dashboard-container').style.display = 'block';
            
            // Set up error handling
            setupErrorHandling();
            
            // Check if we have cached user data
            const cachedUserData = loadUserDataFromCache();
            if (cachedUserData) {
                console.log("Loading cached user data:", cachedUserData);
                updateUserInterface(cachedUserData);
            }
            
            // Set default values in case Firebase is slow or fails
            updateUserDisplayName('User');
            updateUserEmail('user@example.com');
            updateUserPlan('Free');
            
            // Helper functions to update UI elements
            function updateUserDisplayName(name) {
                const usernameElements = document.getElementsByClassName('user-name');
                for (let i = 0; i < usernameElements.length; i++) {
                    usernameElements[i].textContent = name;
                }
            }
            
            function updateUserEmail(email) {
                const emailElements = document.getElementsByClassName('user-email');
                for (let i = 0; i < emailElements.length; i++) {
                    emailElements[i].textContent = email;
                }
            }
            
            function updateUserPlan(plan) {
                const planElements = document.getElementsByClassName('user-plan');
                for (let i = 0; i < planElements.length; i++) {
                    planElements[i].textContent = plan;
                }
                
                // Show correct plan content
                document.querySelector('.free-content').style.display = 'none';
                document.querySelector('.basic-content').style.display = 'none';
                document.querySelector('.plus-content').style.display = 'none';
                
                if (plan.toLowerCase() === 'basic') {
                    document.querySelector('.basic-content').style.display = 'block';
                } else if (plan.toLowerCase() === 'plus') {
                    document.querySelector('.plus-content').style.display = 'block';
                } else {
                    document.querySelector('.free-content').style.display = 'block';
                }
            }
            
            // Setup error handling
            function setupErrorHandling() {
                // Set up dismiss button for error container
                document.getElementById('dismissError').addEventListener('click', function() {
                    document.getElementById('errorContainer').style.display = 'none';
                });
                
                // Set up retry button
                document.getElementById('retryConnection').addEventListener('click', function() {
                    // Hide error message
                    document.getElementById('errorContainer').style.display = 'none';
                    
                    // Show loading indicator on button
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Trying...';
                    this.disabled = true;
                    
                    // Try to reload user data
                    const user = firebase.auth().currentUser;
                    if (user) {
                        loadUserDataFromFirestore(user.uid);
                    } else {
                        try {
                            firebase.auth().onAuthStateChanged(function(user) {
                                if (user) {
                                    loadUserDataFromFirestore(user.uid);
                                }
                            });
                        } catch (e) {
                            console.error("Error during retry:", e);
                        }
                    }
                    
                    // Reset button after 3 seconds
                    setTimeout(() => {
                        this.innerHTML = '<i class="fas fa-sync-alt"></i> Retry';
                        this.disabled = false;
                    }, 3000);
                });
                
                // Add global error handler for Firebase
                window.addEventListener('error', function(event) {
                    if (event.message.includes('firebase') || event.message.includes('auth')) {
                        console.error('Firebase error detected:', event.message);
                        showError('Authentication service unavailable. Some features may be limited.');
                    }
                });
            }
            
            // Function to show error messages
            function showError(message) {
                const errorContainer = document.getElementById('errorContainer');
                document.getElementById('errorMessage').textContent = message;
                errorContainer.style.display = 'block';
                
                // Show retry button for connection-related errors
                const retryButton = document.getElementById('retryConnection');
                if (message.includes('offline') || message.includes('connection') || message.includes('timeout')) {
                    retryButton.style.display = 'inline-block';
                } else {
                    retryButton.style.display = 'none';
                }
                
                // Auto-hide after 10 seconds
                setTimeout(function() {
                    if (errorContainer.style.display !== 'none') {
                        errorContainer.style.display = 'none';
                    }
                }, 10000);
            }
            
            // Try to get user data from Firebase
            try {
                // Check if Firebase is properly initialized
                if (typeof firebase === 'undefined' || !firebase.auth || !firebase.firestore) {
                    throw new Error('Firebase is not properly initialized');
                }
                
                // Check network connectivity
                if (!navigator.onLine) {
                    console.log("User is offline - using default values");
                    showError('You are currently offline. Some features may be limited.');
                    return;
                }

                // Setup Firebase authentication state persistence
                try {
                    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                        .catch(error => {
                            console.error("Error setting auth persistence:", error);
                        });
                } catch (error) {
                    console.error("Error setting up Firebase persistence:", error);
                }

                // Add user data if it exists
                const currentUser = firebase.auth().currentUser;
                console.log("Current user from Firebase:", currentUser);
                
                // If Firebase hasn't loaded the user yet, wait for auth state to change
                if (!currentUser) {
                    console.log("No current user, waiting for auth state change");
                    
                    // Track if we're waiting too long for auth
                    let authTimeout = setTimeout(() => {
                        showError('Authentication timed out. Please try refreshing the page or signing in again.');
                        // Try to redirect to sign-in page after a delay
                        setTimeout(() => {
                            try {
                                window.location.href = 'signin.html?reason=auth_timeout';
                            } catch (e) {
                                console.error("Error redirecting:", e);
                            }
                        }, 5000);
                    }, 15000); // 15 second timeout for auth
                    
                    firebase.auth().onAuthStateChanged(function(user) {
                        // Clear the timeout since we got a response
                        clearTimeout(authTimeout);
                        
                        if (user) {
                            console.log("User from auth state change:", user);
                            // Update UI with user info
                            updateUserDisplayName(user.displayName || 'User');
                            updateUserEmail(user.email);
                            
                            // Get additional user data from Firestore
                            loadUserDataFromFirestore(user.uid);
                        } else {
                            // Show a message if no user is logged in
                            showError('No user is currently signed in. Please sign in to continue.');
                            // Redirect to login after delay
                            setTimeout(() => {
                                try {
                                    window.location.href = 'signin.html?reason=not_authenticated';
                                } catch (e) {
                                    console.error("Error redirecting:", e);
                                }
                            }, 3000);
                        }
                    });
                } else {
                    // Update UI with user info
                    updateUserDisplayName(currentUser.displayName || 'User');
                    updateUserEmail(currentUser.email);
                    
                    // Get additional user data from Firestore
                    loadUserDataFromFirestore(currentUser.uid);
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                let errorMessage = 'Error loading user data';
                
                // Handle specific Firebase auth errors
                if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'Network connection failed. Please check your internet connection.';
                } else if (error.code === 'auth/user-token-expired') {
                    errorMessage = 'Your session has expired. Please sign in again.';
                    setTimeout(() => {
                        window.location.href = 'signin.html?reason=token_expired';
                    }, 3000);
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-user-token') {
                    errorMessage = 'Invalid user session. Please sign in again.';
                    setTimeout(() => {
                        window.location.href = 'signin.html?reason=invalid_user';
                    }, 3000);
                } else {
                    errorMessage += ': ' + error.message;
                }
                
                showError(errorMessage);
            }
            
            // Function to load user data from Firestore
            function loadUserDataFromFirestore(userId) {
                try {
                    // Check network connectivity first
                    if (!navigator.onLine) {
                        showError('Unable to load profile - you are offline. Using default settings.');
                        return;
                    }
                    
                    // Add a retry mechanism
                    let retryCount = 0;
                    const maxRetries = 3;
                    
                    function attemptFetch() {
                        // Set timeout to handle slow connections
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Request timeout')), 10000)
                        );
                        
                        // Attempt to get user data with timeout
                        Promise.race([
                            firebase.firestore().collection('users').doc(userId).get(),
                            timeoutPromise
                        ])
                        .then(doc => {
                            if (doc.exists) {
                                const userData = doc.data();
                                console.log("User data from Firestore:", userData);
                                
                                // Add email from auth to the cached data
                                userData.email = firebase.auth().currentUser.email;
                                
                                // Cache the user data for offline use
                                saveUserDataToCache(userData);
                                
                                // Update UI with user data
                                updateUserInterface(userData);
                            } else {
                                console.log("No user document found in Firestore");
                                showError('No user profile found. Using default settings.');
                            }
                        })
                        .catch(error => {
                            console.error("Error getting user data from Firestore:", error);
                            let errorMessage = 'Unable to load user profile data';
                            
                            if (error.message.includes('timeout')) {
                                errorMessage += ': connection timeout';
                            } else if (error.message.includes('offline')) {
                                errorMessage += ': you are offline';
                            } else {
                                errorMessage += ': ' + error.message;
                            }
                            
                            // Try to retry if it's a network issue
                            if (navigator.onLine && retryCount < maxRetries &&
                                (error.message.includes('timeout') || error.message.includes('offline') || error.code === 'unavailable')) {
                                retryCount++;
                                console.log(`Retrying fetch (${retryCount}/${maxRetries})...`);
                                showError(`Connection issue detected. Retrying (${retryCount}/${maxRetries})...`);
                                
                                // Exponential backoff
                                setTimeout(attemptFetch, 1000 * Math.pow(2, retryCount));
                            } else {
                                showError(errorMessage);
                            }
                        });
                    }
                    
                    // Start the fetch process
                    attemptFetch();
                } catch (error) {
                    console.error("Error in loadUserDataFromFirestore:", error);
                    showError('Error connecting to user database: ' + error.message);
                }
            }
            
            // If Firebase takes too long, make sure we have something displayed
            setTimeout(function() {
                const usernameElements = document.getElementsByClassName('user-name');
                if (!usernameElements[0].textContent || usernameElements[0].textContent.trim() === '') {
                    console.log("Firebase data load timeout - using defaults");
                    updateUserDisplayName('User');
                    updateUserEmail('user@example.com');
                    updateUserPlan('Free');
                    showError('Unable to load user data. Using default settings.');
                }
                
                // Ensure the dashboard is visible even if some components didn't load
                ensureDashboardVisible();
            }, 3000);
            
            // Function to ensure the dashboard is visible regardless of errors
            function ensureDashboardVisible() {
                const dashboardContainer = document.querySelector('.dashboard-container');
                if (dashboardContainer) {
                    dashboardContainer.style.display = 'block';
                }
                
                // Make sure all sections are displayed
                const mainSections = document.querySelectorAll('.section');
                mainSections.forEach(section => {
                    if (section.style.display === 'none') {
                        section.style.display = 'block';
                    }
                });
                
                // Check if the chart loaded
                const chart = document.getElementById('performanceChart');
                if (chart && !window.performanceChart) {
                    try {
                        initializePerformanceChart();
                    } catch (e) {
                        console.error("Failed to initialize chart during recovery:", e);
                    }
                }
            }
            
            // Initialize tabs
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remove active class from all buttons and contents
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Add active class to clicked button and corresponding content
                    button.classList.add('active');
                    const tabId = button.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Username update functionality
            const updateUsernameBtn = document.getElementById('updateUsernameBtn');
            if (updateUsernameBtn) {
                updateUsernameBtn.addEventListener('click', function() {
                    const newUsername = document.getElementById('newUsername').value;
                    
                    // Validation
                    if (!newUsername || newUsername.length < 3) {
                        document.getElementById('usernameUpdateError').textContent = 'Username must be at least 3 characters';
                        document.getElementById('usernameUpdateError').style.display = 'block';
                        document.getElementById('usernameUpdateSuccess').style.display = 'none';
                        return;
                    }
                    
                    // Show loading
                    updateUsernameBtn.disabled = true;
                    updateUsernameBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
                    
                    // Get current user
                    const user = firebase.auth().currentUser;
                    if (user) {
                        // Update display name in Firebase Auth
                        user.updateProfile({
                            displayName: newUsername
                        }).then(() => {
                            // Update username in Firestore
                            return firebase.firestore().collection('users').doc(user.uid).update({
                                username: newUsername
                            });
                        }).then(() => {
                            // Success
                            document.getElementById('usernameUpdateSuccess').style.display = 'block';
                            document.getElementById('usernameUpdateError').style.display = 'none';
                            
                            // Update all username displays on the page
                            const usernameElements = document.getElementsByClassName('user-name');
                            for (let i = 0; i < usernameElements.length; i++) {
                                usernameElements[i].textContent = newUsername;
                            }
                            
                            // Clear input field
                            document.getElementById('newUsername').value = '';
                            
                            // Reset button
                            updateUsernameBtn.disabled = false;
                            updateUsernameBtn.textContent = 'UPDATE USERNAME';
                            
                            // Hide success message after 3 seconds
                            setTimeout(() => {
                                document.getElementById('usernameUpdateSuccess').style.display = 'none';
                            }, 3000);
                        }).catch((error) => {
                            // Error
                            document.getElementById('usernameUpdateError').textContent = error.message;
                            document.getElementById('usernameUpdateError').style.display = 'block';
                            document.getElementById('usernameUpdateSuccess').style.display = 'none';
                            
                            // Reset button
                            updateUsernameBtn.disabled = false;
                            updateUsernameBtn.textContent = 'UPDATE USERNAME';
                        });
                    }
                });
            }
            
            // Password update functionality
            const updatePasswordBtn = document.getElementById('updatePasswordBtn');
            if (updatePasswordBtn) {
                updatePasswordBtn.addEventListener('click', function() {
                    const currentPassword = document.getElementById('currentPassword').value;
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmNewPassword = document.getElementById('confirmNewPassword').value;
                    
                    // Validation
                    if (!currentPassword) {
                        document.getElementById('passwordUpdateError').textContent = 'Please enter your current password';
                        document.getElementById('passwordUpdateError').style.display = 'block';
                        document.getElementById('passwordUpdateSuccess').style.display = 'none';
                        return;
                    }
                    
                    if (!newPassword || newPassword.length < 6) {
                        document.getElementById('passwordUpdateError').textContent = 'New password must be at least 6 characters';
                        document.getElementById('passwordUpdateError').style.display = 'block';
                        document.getElementById('passwordUpdateSuccess').style.display = 'none';
                        return;
                    }
                    
                    if (newPassword !== confirmNewPassword) {
                        document.getElementById('passwordUpdateError').textContent = 'Passwords do not match';
                        document.getElementById('passwordUpdateError').style.display = 'block';
                        document.getElementById('passwordUpdateSuccess').style.display = 'none';
                        return;
                    }
                    
                    // Show loading
                    updatePasswordBtn.disabled = true;
                    updatePasswordBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
                    
                    // Get current user
                    const user = firebase.auth().currentUser;
                    if (user) {
                        // Create credential with current password
                        const credential = firebase.auth.EmailAuthProvider.credential(
                            user.email,
                            currentPassword
                        );
                        
                        // Reauthenticate the user
                        user.reauthenticateWithCredential(credential).then(() => {
                            // Change password
                            return user.updatePassword(newPassword);
                        }).then(() => {
                            // Success
                            document.getElementById('passwordUpdateSuccess').style.display = 'block';
                            document.getElementById('passwordUpdateError').style.display = 'none';
                            
                            // Clear input fields
                            document.getElementById('currentPassword').value = '';
                            document.getElementById('newPassword').value = '';
                            document.getElementById('confirmNewPassword').value = '';
                            
                            // Reset button
                            updatePasswordBtn.disabled = false;
                            updatePasswordBtn.textContent = 'UPDATE PASSWORD';
                            
                            // Hide success message after 3 seconds
                            setTimeout(() => {
                                document.getElementById('passwordUpdateSuccess').style.display = 'none';
                            }, 3000);
                        }).catch((error) => {
                            // Error
                            let errorMessage = error.message;
                            if (error.code === 'auth/wrong-password') {
                                errorMessage = 'Current password is incorrect';
                            }
                            
                            document.getElementById('passwordUpdateError').textContent = errorMessage;
                            document.getElementById('passwordUpdateError').style.display = 'block';
                            document.getElementById('passwordUpdateSuccess').style.display = 'none';
                            
                            // Reset button
                            updatePasswordBtn.disabled = false;
                            updatePasswordBtn.textContent = 'UPDATE PASSWORD';
                        });
                    }
                });
            }
            
            // Account deletion functionality
            const deleteAccountBtn = document.getElementById('deleteAccountBtn');
            if (deleteAccountBtn) {
                deleteAccountBtn.addEventListener('click', function() {
                    const password = document.getElementById('deleteAccountPassword').value;
                    const confirmCheckbox = document.getElementById('confirmAccountDeletion');
                    
                    // Validation
                    if (!password) {
                        document.getElementById('deleteAccountError').textContent = 'Please enter your password to confirm';
                        document.getElementById('deleteAccountError').style.display = 'block';
                        return;
                    }
                    
                    if (!confirmCheckbox.checked) {
                        document.getElementById('deleteAccountError').textContent = 'Please confirm that you understand this action cannot be undone';
                        document.getElementById('deleteAccountError').style.display = 'block';
                        return;
                    }
                    
                    // Ask for final confirmation
                    if (!confirm('Are you absolutely sure you want to delete your RouteLag account? This action CANNOT be undone.')) {
                        return;
                    }
                    
                    // Show loading
                    deleteAccountBtn.disabled = true;
                    deleteAccountBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                    
                    // Get current user
                    const user = firebase.auth().currentUser;
                    if (user) {
                        // Create credential with current password
                        const credential = firebase.auth.EmailAuthProvider.credential(
                            user.email,
                            password
                        );
                        
                        // Reauthenticate the user
                        user.reauthenticateWithCredential(credential).then(() => {
                            // First delete user data from Firestore
                            const batch = firebase.firestore().batch();
                            
                            // Delete user document
                            batch.delete(firebase.firestore().collection('users').doc(user.uid));
                            
                            // Delete user activities
                            return firebase.firestore().collection('activities')
                                .where('userId', '==', user.uid)
                                .get()
                                .then((querySnapshot) => {
                                    querySnapshot.forEach(doc => {
                                        batch.delete(doc.ref);
                                    });
                                    
                                    // Commit the batch
                                    return batch.commit();
                                })
                                .then(() => {
                                    // Finally delete the user account
                                    return user.delete();
                                });
                        }).then(() => {
                            // Redirect to home page
                            window.location.href = 'index.html?deleted=true';
                        }).catch((error) => {
                            // Error
                            let errorMessage = error.message;
                            if (error.code === 'auth/wrong-password') {
                                errorMessage = 'Password is incorrect';
                            }
                            
                            document.getElementById('deleteAccountError').textContent = errorMessage;
                            document.getElementById('deleteAccountError').style.display = 'block';
                            
                            // Reset button
                            deleteAccountBtn.disabled = false;
                            deleteAccountBtn.textContent = 'DELETE MY ACCOUNT';
                        });
                    }
                });
            }
            
            // Initialize performance chart with better error handling
            try {
                initializePerformanceChart();
            } catch (error) {
                console.error("Error initializing performance chart:", error);
                const chartContainer = document.getElementById('performanceChart').parentNode;
                chartContainer.innerHTML = '<div class="chart-error">Performance data visualization unavailable</div>';
                showError('Unable to load performance chart: ' + error.message);
            }
            
            function initializePerformanceChart() {
                const ctx = document.getElementById('performanceChart').getContext('2d');
                
                // Default data if no user data available
                const labels = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                const pingData = [45, 42, 40, 43, 38, 39, 41];
                const fpsData = [60, 62, 64, 60, 68, 70, 65];
                
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(58, 123, 213, 0.6)');
                gradient.addColorStop(1, 'rgba(0, 210, 255, 0.05)');
                
                const pingGradient = ctx.createLinearGradient(0, 0, 0, 400);
                pingGradient.addColorStop(0, 'rgba(255, 105, 180, 0.6)');
                pingGradient.addColorStop(1, 'rgba(255, 105, 180, 0.05)');
                
                const performanceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'FPS',
                                data: fpsData,
                                borderColor: '#3a7bd5',
                                backgroundColor: gradient,
                                borderWidth: 2,
                                pointBackgroundColor: '#3a7bd5',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Ping (ms)',
                                data: pingData,
                                borderColor: '#ff69b4',
                                backgroundColor: pingGradient,
                                borderWidth: 2,
                                pointBackgroundColor: '#ff69b4',
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    boxWidth: 12,
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    color: '#ccc'
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(15, 17, 26, 0.9)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#3a7bd5',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.05)'
                                },
                                ticks: {
                                    color: '#ccc'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.05)'
                                },
                                ticks: {
                                    color: '#ccc'
                                }
                            }
                        }
                    }
                });
                
                // Store chart in global scope for refreshing
                window.performanceChart = performanceChart;
                
                return performanceChart;
            }
            
            // Refresh button handler
            document.getElementById('refreshButton').addEventListener('click', function() {
                try {
                    // Simulate new data
                    if (window.performanceChart) {
                        const newFpsData = window.performanceChart.data.datasets[0].data.map(() => 
                            Math.floor(Math.random() * 20) + 55);
                        const newPingData = window.performanceChart.data.datasets[1].data.map(() => 
                            Math.floor(Math.random() * 15) + 35);
                            
                        window.performanceChart.data.datasets[0].data = newFpsData;
                        window.performanceChart.data.datasets[1].data = newPingData;
                        window.performanceChart.update();
                        
                        // Update metrics
                        const pingReduction = Math.floor(Math.random() * 10) + 20;
                        const fpsBoost = Math.floor(Math.random() * 15) + 15;
                        
                        const pingElements = document.getElementsByClassName('ping-reduction');
                        for (let i = 0; i < pingElements.length; i++) {
                            pingElements[i].textContent = pingReduction + '%';
                        }
                        
                        const fpsElements = document.getElementsByClassName('fps-boost');
                        for (let i = 0; i < fpsElements.length; i++) {
                            fpsElements[i].textContent = fpsBoost + '%';
                        }
                        
                        const optimizations = parseInt(document.getElementById('totalOptimizations').textContent || '0') + 1;
                        document.getElementById('totalOptimizations').textContent = optimizations;
                        document.getElementById('lastOptimized').textContent = new Date().toLocaleDateString();
                    } else {
                        // If chart isn't available, try to initialize it
                        initializePerformanceChart();
                    }
                    
                    this.classList.add('refreshing');
                    setTimeout(() => {
                        this.classList.remove('refreshing');
                    }, 1000);
                } catch (error) {
                    console.error("Error refreshing data:", error);
                    showError('Error refreshing performance data: ' + error.message);
                }
            });
            
            // Function to check online status and update UI accordingly
            function updateOnlineStatus() {
                const offlineIndicator = document.getElementById('offline-indicator');
                if (navigator.onLine) {
                    offlineIndicator.style.display = 'none';
                } else {
                    offlineIndicator.style.display = 'block';
                }
            }

            // Initial check of online status
            updateOnlineStatus();
            
            // Add event listeners for online/offline status
            window.addEventListener('online', function() {
                console.log('Connection restored');
                document.getElementById('errorContainer').style.display = 'none';
                updateOnlineStatus();
                
                // Try to reload user data if we're online
                const user = firebase.auth().currentUser;
                if (user) {
                    loadUserDataFromFirestore(user.uid);
                }
            });
            
            window.addEventListener('offline', function() {
                console.log('Connection lost');
                showError('You are currently offline. Some features may be limited.');
                updateOnlineStatus();
            });
            
            // Function to save user data to local storage
            function saveUserDataToCache(userData) {
                try {
                    // Don't include sensitive data in cache
                    const cacheData = {
                        username: userData.username || 'User',
                        email: userData.email || 'user@example.com',
                        plan: userData.plan || 'Free',
                        stats: userData.stats || {
                            pingReduction: '0%',
                            fpsBoost: '0%',
                            totalOptimizations: '0',
                            lastOptimized: null
                        },
                        lastUpdated: new Date().toISOString()
                    };
                    
                    localStorage.setItem('routelag_user_data', JSON.stringify(cacheData));
                    console.log("User data cached successfully");
                } catch (error) {
                    console.error("Error caching user data:", error);
                }
            }
            
            // Function to load user data from local storage
            function loadUserDataFromCache() {
                try {
                    const cachedData = localStorage.getItem('routelag_user_data');
                    if (cachedData) {
                        const userData = JSON.parse(cachedData);
                        
                        // Check if data is stale (older than 1 day)
                        const lastUpdated = new Date(userData.lastUpdated);
                        const now = new Date();
                        const oneDayInMs = 24 * 60 * 60 * 1000;
                        
                        if (now - lastUpdated > oneDayInMs) {
                            console.log("Cached data is stale, will fetch fresh data");
                        }
                        
                        return userData;
                    }
                } catch (error) {
                    console.error("Error loading cached user data:", error);
                }
                return null;
            }
            
            // Function to update the user interface with data
            function updateUserInterface(userData) {
                if (userData.username) {
                    updateUserDisplayName(userData.username);
                }
                
                if (userData.email) {
                    updateUserEmail(userData.email);
                }
                
                if (userData.plan) {
                    updateUserPlan(userData.plan.charAt(0).toUpperCase() + userData.plan.slice(1));
                }
                
                if (userData.stats) {
                    const pingReductionElements = document.getElementsByClassName('ping-reduction');
                    for (let i = 0; i < pingReductionElements.length; i++) {
                        pingReductionElements[i].textContent = userData.stats.pingReduction || '0%';
                    }
                    
                    const fpsBoostElements = document.getElementsByClassName('fps-boost');
                    for (let i = 0; i < fpsBoostElements.length; i++) {
                        fpsBoostElements[i].textContent = userData.stats.fpsBoost || '0%';
                    }
                    
                    document.getElementById('totalOptimizations').textContent = userData.stats.totalOptimizations || '0';
                    
                    if (userData.stats.lastOptimized) {
                        let dateStr = userData.stats.lastOptimized;
                        if (typeof dateStr === 'object' && dateStr.toDate) {
                            dateStr = dateStr.toDate();
                        }
                        const date = new Date(dateStr);
                        document.getElementById('lastOptimized').textContent = date.toLocaleDateString();
                    } else {
                        document.getElementById('lastOptimized').textContent = 'Never';
                    }
                }
            }
        });
    </script>
</body>
</html> 
